<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&family=Lobster&display=swap" rel="stylesheet">

    <link rel="shortcut icon" href="Imagens/LogoListaCasamento.png" type="image/x-icon">

    <link rel="stylesheet" href="{{url_for('static', filename='estilo_produto.css')}}">
    <title>Lista de produtos: Casamento de Allana e Yuan</title>
</head>

<body>
    <header>
        <nav id="navega√ß√£o_header">
            <div id="SidebarLogo">
                <button type="button" onclick="on_sidebar(event)">
                    <img src="{{url_for('static', filename='Imagens/LogoListaCasamento.png')}}" id="logo">
                    <img src="{{url_for('static', filename='Imagens/iconeSidebar.png')}}" id="sidebar-icon">
                </button>
            </div>
            <a href="{{url_for('index')}}#Main_principal" class="nav_principal" id="nav1"><strong>Inicio</strong></a>
            <a href="{{url_for('index')}}#PrincipalProdutos" class="nav_principal" id="nav2"><strong>presentes</strong></a>
            <a href="{{url_for('lista')}}" class="nav_principal" id="nav3"><strong>Minha Lista</strong></a>
            <a href="https://docs.google.com/forms/d/e/1FAIpQLScTrqGxIXzhjjmEwVohj4JPk2oVI8usU6HQpZvKFiIvFrlvNg/viewform?usp=sharing&ouid=102149957380584088023" class="nav_principal" id="nav4"><strong>Confirmar Presen√ßa</strong></a>
            <a href="https://drive.google.com/file/d/18IQd0QKMT-EI2CbqRfumyO6ygH7X7QWO/view?usp=drivesdk" class="nav_principal" id="nav5"><strong>Manual do Convidado</strong></a>
            <a href="{{url_for('login')}}" class="inscricao" id="inscricao">
                <img src="{{url_for('static', filename='Imagens/Usuario.jpg')}}" alt="Usuario" id="usuario">
            </a>
        </nav>
        
        <nav id="navega√ß√£o_header_sidebar">
            <a href="{{url_for('index')}}#Main_principal" class="nav_principal" id="nav1"><strong>Inicio</strong></a>
            <a href="{{url_for('index')}}#PrincipalProdutos" class="nav_principal" id="nav2"><strong>presentes</strong></a>
            <a href="{{url_for('lista')}}" class="nav_principal" id="nav3"><strong>Minha Lista</strong></a>
            <a href="https://docs.google.com/forms/d/e/1FAIpQLScTrqGxIXzhjjmEwVohj4JPk2oVI8usU6HQpZvKFiIvFrlvNg/viewform?usp=sharing&ouid=102149957380584088023" class="nav_principal" id="nav4"><strong>Confirmar Presen√ßa</strong></a>
            <a href="https://drive.google.com/file/d/18IQd0QKMT-EI2CbqRfumyO6ygH7X7QWO/view?usp=drivesdk" class="nav_principal" id="nav5"><strong>Manual do Convidado</strong></a>
        </nav>
    </header>
    
    <main>        
        <img src="{{url_for('static', filename='Imagens/Division.jpg')}}" alt="Divis√≥ria do site" class="SeparacaoSetor" id="LinhaNav">
        {% for key, list_info in info_produto.items() %}
            <section id="Main_principal" data-quantidade="{{list_info.quantidade}}">
                <h1 class="titulo_section" id="titulo_section_phone">Presente Selecionado</h1>
                <div class="produto" id="produtoEscolhido">
                    <img src="{{url_for('static', filename=list_info.img)}}" alt="Imagem do produto">
                </div>

                <div class="produtoInformacao" id="produtoInformacao">
                    <div class="titulos">
                        <h1 class="titulo_section">Presente Selecionado</h1>
                        <h2 class="titulo_produto">{{list_info.nome}}</h2>
                    </div>
                    <div class="Descricao">
                        <div class="titulo_descricao">
                            <h2>Descri√ß√£o:</h2>
                        </div>
                        <div class="atributos">
                            <div class="caracteristicas">
                                <div class="cor">
                                    <p><span>Cores- </span></p>
                                    <br>
                                    <form action="/produto/{{id}}" method="post" id="form-cor">
                                        {% for cor in list_info.cores.split(',') %}
                                            <input type="checkbox" name="cor_selecionada" value="{{ cor.strip() }}" id="{{ cor.strip() }}"  class="cor-checkbox" >
                                        {% endfor %}
                                    </form>
                                </div>
                                <div class="caracteristica">
                                    <p>{{list_info.list_info[0]}}</p>
                                </div>
                            </div>
                            {% for func in list_info.list_info[1:] %}
                                <div class="funcao">
                                    <p>{{func}}</p>
                                </div>
                            {% endfor %}
                            <div class="funcao">
                                <p id="quantidade" data-quantidade="{{list_info.quantidade}}">Quantidade: {{list_info.quantidade}}</p>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="Assinar">
                        <div class="assine">
                            <form action="/produto/{{id}}" method="post" id="form-assinar">
                                <input type="hidden" name="Assinar_func" value="Assinar_func">
                                <button onClick="assinarProduto()" type="button" id="envioDeAssinatura">
                                    <img src="{{url_for('static', filename='Imagens/CanetaPena.png')}}" alt="Caneta Pena" id="CanetaPenaIMG" style="cursor: pointer;">
                                    <p><strong>Assine aqui</strong></p>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div id="informativo_assinatura">
                        <p>N√£o consegue assinar? <br>Verifique se voc√™ j√° fez login</p>
                    </div>
                </div>
            </section>
        {% endfor %}
        <img src="{{url_for('static', filename='Imagens/Division.jpg')}}" alt="Divis√≥ria do site" class="SeparacaoSetor" id="LinhaProdutos">      
    </main>
</body>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    const checkboxes = Array.from(document.querySelectorAll('.cor-checkbox'));
    const btnAssinar = document.getElementById('envioDeAssinatura');
    const formAssinar = document.getElementById('form-assinar');
    const produtoEl = document.getElementById('quantidade');

    const getQuantidadeDisponivel = () => {
        if (!produtoEl || !produtoEl.dataset.quantidade) return null;
        const q = parseInt(produtoEl.dataset.quantidade, 10);
        return Number.isNaN(q) ? null : q;
    };

    // Se houver apenas 1 cor dispon√≠vel, marcar automaticamente
    if (checkboxes.length === 1) {
        const only = checkboxes[0];
        if (!only.checked) only.checked = true;
    }

    // UX: limitar sele√ß√£o a 2 (se passar, desmarca a √∫ltima sele√ß√£o e avisa)
    checkboxes.forEach(ch => {
        ch.addEventListener('change', (ev) => {
        const selecionadas = document.querySelectorAll('.cor-checkbox:checked');
        if (selecionadas.length > 2) {
            // desmarca a caixa que acabou de ser marcada
            ev.target.checked = false;
            alert("Voc√™ s√≥ pode selecionar no m√°ximo 2 cores.");
        }
        });
    });

    // Fun√ß√£o que coleta valores das cores selecionadas
    const getSelecionadas = () => {
        return Array.from(document.querySelectorAll('.cor-checkbox:checked'))
        .map(el => el.value.trim())
        .filter(Boolean);
    };

    btnAssinar.addEventListener('click', async (e) => {
        e.preventDefault();

        // Recoletar selecionadas (pode ter sido auto marcada)
        const selecionadas = getSelecionadas();

        // Se houver apenas 1 cor dispon√≠vel e nenhuma marcada (caso raro), marcar e recolher
        if (checkboxes.length === 1 && selecionadas.length === 0) {
        checkboxes[0].checked = true;
        }

        const selecionadasAtual = getSelecionadas();

        if (selecionadasAtual.length < 1) {
        alert("Selecione pelo menos 1 cor.");
        return;
        }

        if (selecionadasAtual.length > 2) {
        alert("Voc√™ s√≥ pode selecionar no m√°ximo 2 cores.");
        return;
        }

        const qtd = getQuantidadeDisponivel();
        if (qtd !== null && selecionadasAtual.length > qtd) {
        alert(`Voc√™ escolheu ${selecionadasAtual.length} cores, mas s√≥ existem ${qtd} produto dispon√≠vel.`);
        return;
        }

        // Criar FormData a partir do formAssinar e garantir que as cores sejam anexadas
        const formData = new FormData(formAssinar);

        // Remover entradas antigas 'cor_selecionada' caso existam no form (evita duplicatas)
        // Note: FormData n√£o tem m√©todo direto para remover por nome em todos os browsers,
        // ent√£o recriamos um novo FormData filtrando se necess√°rio.
        const fd = new FormData();
        // copiar todos os campos do formAssinar exceto cor_selecionada
        for (const pair of formData.entries()) {
        const [name, value] = pair;
        if (name === 'cor_selecionada') continue;
        fd.append(name, value);
        }
        // anexar as cores selecionadas (mesmo que os inputs estejam em outro form)
        selecionadasAtual.forEach(c => fd.append('cor_selecionada', c));

        btnAssinar.disabled = true;

        try {
        const resp = await fetch(formAssinar.action, {
            method: 'POST',
            body: fd,
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin'
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
            alert(data.error || "Erro ao processar a requisi√ß√£o.");
            if (data.redirect) window.location.href = data.redirect;
            return;
        }

        if (data.redirect) {
            alert("üéâ Assinatura realizada com sucesso!");
            window.location.href = data.redirect;
        } else {
            window.location.reload();
        }
        } catch (err) {
        console.error(err);
        alert("Erro de rede. Tente novamente.");
        } finally {
        btnAssinar.disabled = false;
        }
    });
    });

    function on_sidebar(event) {
    event.stopPropagation();
    const sidebar = document.getElementById('navega√ß√£o_header_sidebar');
    sidebar.classList.toggle('open');}
</script>

</html>
